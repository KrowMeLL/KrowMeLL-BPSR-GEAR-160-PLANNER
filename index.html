<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gear Planner | S2 Optimized</title>
    <style>
        /* --- VISUAL THEME: DEEP NEBULA --- */
        :root {
            --bg-grad: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --panel-bg: rgba(30, 27, 46, 0.95);
            --accent-primary: #00d2ff; /* Cyan Neon */
            --accent-secondary: #3a7bd5;
            --highlight: #f72585; /* Pink Neon */
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --border: 1px solid #3b3b58;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg-grad); 
            color: var(--text-main); padding: 20px; display: flex; 
            justify-content: center; min-height: 100vh; margin: 0;
        }
        .main-wrapper { 
            display: flex; flex-wrap: wrap; gap: 25px; 
            width: 100%; max-width: 1600px; 
        }

        /* PAINÉIS */
        .panel { 
            background-color: var(--panel-bg); padding: 25px; 
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); 
            border: var(--border); backdrop-filter: blur(10px);
        }
        .planner-panel { flex: 3; min-width: 850px; }
        .calc-panel { 
            flex: 1; min-width: 300px; position: sticky; 
            top: 20px; height: fit-content; background: #161625;
        }

        h2 { 
            text-align: center; color: var(--accent-primary); margin: 0 0 20px 0; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
        }

        /* ABAS */
        .tab-container { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #2d2d44; }
        .tab-btn {
            background: none; border: none; color: var(--text-muted); 
            padding: 12px 30px; font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: 0.3s; border-bottom: 3px solid transparent;
        }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CONTROLES E INPUTS */
        .controls-row, .global-controls {
            background: #252538; padding: 15px; border-radius: 8px; 
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
            flex-wrap: wrap; justify-content: center; border: var(--border);
        }
        select, input[type="number"] { 
            background: #11111a; border: 1px solid #444; color: #fff; 
            padding: 8px; border-radius: 4px; width: 100%; transition: 0.2s;
        }
        select:focus, input:focus { border-color: var(--accent-primary); outline: none; }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .radio-label { cursor: pointer; color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .radio-label:hover { color: #fff; }
        input[type="radio"] { accent-color: var(--accent-primary); transform: scale(1.2); }
        input[type="checkbox"] { accent-color: var(--highlight); transform: scale(1.2); cursor: pointer;}

        /* TABELA DE GEAR */
        .gear-row { 
            display: grid; grid-template-columns: 1fr 0.4fr 0.8fr 0.8fr 0.8fr 1.4fr 1.2fr; 
            gap: 8px; align-items: center; padding: 8px 10px; border-bottom: 1px solid #2d2d44;
        }
        .gear-header { color: var(--accent-primary); font-weight: bold; border-bottom: 2px solid #444; font-size: 0.9em; }
        .slot-name { font-weight: bold; color: #fff; font-size: 0.9em; }

        /* OTIMIZADOR E LENDÁRIOS */
        .optimizer-intro { background: #252538; padding: 15px; border-radius: 8px; color: var(--text-muted); font-size: 0.9em; margin-bottom: 20px; border-left: 3px solid var(--highlight); }
        .opt-input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .opt-input-group label { color: var(--accent-primary); font-size: 0.85em; font-weight: bold; display: block; margin-bottom: 5px; }
        
        button.action-btn { 
            width: 100%; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; color: #fff;
            transition: 0.2s; margin-top: 10px; text-transform: uppercase;
        }
        .btn-blue { background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary)); }
        .btn-pink { background: linear-gradient(90deg, #c72c68, var(--highlight)); }
        button.action-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }

        .results-area { margin-top: 20px; border-top: 2px solid #333; padding-top: 15px; }
        .result-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; }
        .result-val { color: var(--accent-primary); font-weight: bold; }
        
        .footer-credits { width: 100%; text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #333; color: #666; font-size: 0.8em; }
        .dynamic-note { font-size: 0.8em; color: #889; margin-top: 20px; background: #161620; padding: 15px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="panel planner-panel">
        <h2>RaoH | S2 Gear Planner</h2>
        
        <div class="tab-container">
            <button class="tab-btn active" onclick="ui.switchTab('planner')">Manual Planner</button>
            <button class="tab-btn" onclick="ui.switchTab('optimizer')">Auto-Optimizer</button>
        </div>

        <div class="controls-row">
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="buildType" value="Strength" checked onchange="logic.updateAll()"> STR</label>
                <label class="radio-label"><input type="radio" name="buildType" value="Intelligence" onchange="logic.updateAll()"> INT</label>
                <label class="radio-label"><input type="radio" name="buildType" value="Agility" onchange="logic.updateAll()"> AGI</label>
            </div>
            <div style="margin-left: 20px; display:flex; align-items:center; gap:10px;">
                <label style="color:var(--accent-primary); font-weight:bold;">Class Spec:</label>
                <select id="class-spec" onchange="logic.updateAll()" style="width:150px;"></select>
            </div>
        </div>

        <div id="tab-planner" class="tab-content active">
            <div class="global-controls">
                <span class="global-label" style="color:var(--highlight)">Set All Reforge:</span>
                <select id="global-reforge" onchange="logic.applyGlobal(this.value)" style="max-width:200px;">
                    <option value="">- Select -</option>
                    <option value="Versatility">Versatility</option>
                    <option value="Mastery">Mastery</option>
                    <option value="Haste">Haste</option>
                    <option value="Crit">Crit</option>
                    <option value="Luck">Luck</option>
                </select>
            </div>
            <div class="gear-row gear-header">
                <div>Slot</div><div style="text-align:center">Raid</div><div>Primary</div><div>Secondary</div><div>Reforge</div><div>Legendary</div>
            </div>
            <div id="gear-container"></div>
        </div>

        <div id="tab-optimizer" class="tab-content">
            <div class="optimizer-intro">Define your target percentages. The system will simulate thousands of combinations to find the closest match.</div>
            <div class="opt-input-grid">
                <div class="opt-input-group"><label>Target Vers %</label><input type="number" id="opt-vers" placeholder="e.g. 10"></div>
                <div class="opt-input-group"><label>Target Mast %</label><input type="number" id="opt-mast" placeholder="e.g. 50"></div>
                <div class="opt-input-group"><label>Target Haste %</label><input type="number" id="opt-haste" placeholder="e.g. 20"></div>
                <div class="opt-input-group"><label>Target Crit %</label><input type="number" id="opt-crit" placeholder="e.g. 20"></div>
                <div class="opt-input-group"><label>Target Luck %</label><input type="number" id="opt-luck" placeholder="e.g. 5"></div>
                <div class="opt-input-group"><label style="color:var(--highlight)">Total Agility</label><input type="number" id="opt-agi" placeholder="Stat Value"></div>
            </div>
            <button class="action-btn btn-pink" onclick="optimizer.run()">Run Smart Optimization</button>
            <div id="opt-status" style="text-align:center; margin-top:10px; color:var(--highlight); font-weight:bold; min-height:20px;"></div>
            <div class="opt-options">
                <label class="opt-check-label"><input type="checkbox" id="opt-keep-selected"> Lock Current Gear</label>
                <label class="opt-check-label"><input type="checkbox" id="opt-optimize-imagine"> Optimize Imagines</label>
                <label class="opt-check-label"><input type="checkbox" id="opt-unlimited-raid"> Unlimited Raid Armor</label>
            </div>
        </div>

        <div class="imagine-section">
            <div class="imagine-title">Imagine Slots</div>
            <div class="imagine-row">
                <span class="slot-name">Imagine 1</span>
                <select id="img-type-1" onchange="logic.calculate()"></select>
                <select id="img-lvl-1" onchange="logic.calculate()"></select>
            </div>
            <div class="imagine-row">
                <span class="slot-name">Imagine 2</span>
                <select id="img-type-2" onchange="logic.calculate()"></select>
                <select id="img-lvl-2" onchange="logic.calculate()"></select>
            </div>
        </div>

        <div class="dynamic-note" id="dynamic-footer-note"></div>
        <div class="footer-credits" id="credits-area"></div>
    </div>

    <div class="panel calc-panel">
        <h2>Results</h2>
        <div class="raw-gear-stats">
            <h3 style="margin:0 0 10px 0; font-size:1em; color:#fff; border-bottom:1px solid #444; padding-bottom:5px;">Raw Totals</h3>
            <div class="raw-row"><span>Vers:</span> <span class="raw-val" id="raw-vers">0</span></div>
            <div class="raw-row"><span>Mast:</span> <span class="raw-val" id="raw-mast">0</span></div>
            <div class="raw-row"><span>Haste:</span> <span class="raw-val" id="raw-haste">0</span></div>
            <div class="raw-row"><span>Crit:</span> <span class="raw-val" id="raw-crit">0</span></div>
            <div class="raw-row"><span>Luck:</span> <span class="raw-val" id="raw-luck">0</span></div>
        </div>
        
        <div class="base-stats">
            <div class="input-group"><label>Base Vers</label><input type="number" id="base-vers" value="0"></div>
            <div class="input-group"><label>Base Mast</label><input type="number" id="base-mast" value="0"></div>
            <div class="input-group"><label>Base Haste</label><input type="number" id="base-haste" value="0"></div>
            <div class="input-group"><label>Base Crit</label><input type="number" id="base-crit" value="0"></div>
            <div class="input-group"><label>Base Luck</label><input type="number" id="base-luck" value="0"></div>
            <div class="input-group"><label style="color:#aaa">Base Agi</label><input type="number" id="base-agi" value="0"></div>
        </div>

        <button class="action-btn btn-blue" onclick="logic.calculate()">Update Calculation</button>

        <div class="results-area">
            <h3 style="color:var(--text-main)">Final %</h3>
            <div class="result-row"><span>Versatility:</span> <span class="result-val" id="r-vers">0%</span></div>
            <div class="result-row"><span>Mastery:</span> <span class="result-val" id="r-mast">6.00%</span></div>
            <div class="result-row"><span>Haste:</span> <span class="result-val" id="r-haste">0%</span></div>
            <div class="result-row"><span>Crit Rate:</span> <span class="result-val" id="r-crit">5.00%</span></div>
            <div class="result-row"><span>Luck:</span> <span class="result-val" id="r-luck">5.00%</span></div>
            
            <div class="result-row" id="raid-special-row" style="display:none; border-top:1px dashed var(--accent-primary); margin-top:10px;">
                <span id="raid-special-label" style="color:var(--highlight);">Raid Bonus:</span>
                <span class="result-val" id="raid-special-val" style="color:var(--highlight);">0%</span>
            </div>
            <div id="legendary-summary" style="display:none; margin-top:10px; font-size:0.9em; border-top:1px solid #333; padding-top:5px;">
                <div class="raw-row"><span>Cast Spd:</span> <span id="leg-cast" style="color:var(--accent-primary)">0%</span></div>
                <div class="raw-row"><span>Atk Spd:</span> <span id="leg-atk" style="color:var(--accent-primary)">0%</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. GAME DATA CONFIGURATION (EDIT HERE) ---
    const GAME_DATA = {
        TEXT: {
            CREDITS: "Produzido por Luxxio // Atualizado por: KrowMeLL",
            NOTES: `<strong>Gear Values:</strong><br>
                    • <strong>Raid Weapon:</strong> 2480 P / 2480 S (No Reforge)<br>
                    • <strong>Raid Armor:</strong> 954 P / 954 S / 286 Reforge<br>
                    • <strong>Standard Weapon:</strong> 1908 P / 954 S / 572 Reforge<br>
                    • <strong>Standard Armor:</strong> 954 P / 477 S / 286 Reforge`
        },
        STATS: ["Versatility", "Mastery", "Haste", "Crit", "Luck"],
        SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Earrings", "Necklace", "Ring", "Bracelet (L)", "Bracelet (R)", "Charm"],
        RAID_SLOTS: ["Weapon", "Helmet", "Chest", "Gloves", "Boots", "Bracelet (L)", "Bracelet (R)"],
        IMAGINE: {
            TYPES: ["Mastery", "Haste", "Versatility"],
            VALS: [3584, 4636, 5688, 6740, 7792, 8960]
        },
        GEMS: ["Haste", "Crit", "Luck", "Mastery"], // Colors
        LEGENDARY: ["-", "Attack Speed", "Cast Speed", "ATK/MATK", "Dmg Bonus", "Shield", "Healing Output", "Res Break", "All Res", "Armor", "Max HP"],
        // Specific Raid Bonuses (Season 2)
        RAID_BONUS: {
            "Block": { l: "Luck", v: 6.0, t: "p" }, // t: 'p' (percent), 'f' (flat)
            "Earthfort": { l: "Shield (Vers)", v: 0.0, t: "p" },
            "Iado": { l: "Crit DMG", v: 0.0, t: "p" },
            "Moonstrike": { l: "Luck", v: 0.0, t: "p" },
            "Icicle": { l: "Crit DMG", v: 0.0, t: "p" },
            "Frostbeam": { l: "Ranged DMG", v: 0, t: "f" },
            "Vanguard": { l: "Melee DMG", v: 0, t: "f" },
            "Skyward": { l: "Lucky Strike DMG", v: 20.0, t: "p" },
            "Smite": { l: "Ranged DMG", v: 0, t: "f" },
            "Lifebind": { l: "Healing Output", v: 0.0, t: "p" },
            "Wildpack": { l: "Ranged DMG", v: 0, t: "f" },
            "Falconry": { l: "Crit DMG", v: 0.0, t: "p" },
            "Recovery": { l: "DMG Bonus", v: 0.0, t: "p" },
            "Shield": { l: "Melee DMG", v: 0, t: "f" },
            "Concerto": { l: "Crit Healing", v: 0.0, t: "p" },
            "Dissonance": { l: "Luck Effect DMG", v: 0, t: "f" }
        },
        SPECS: {
            "Vanguard": ["Haste", "Mastery"], "Skyward": ["Crit", "Luck"], "Shield": ["Haste", "Mastery"],
            "Recovery": ["Crit", "Mastery"], "Iado": ["Crit", "Mastery"], "Moonstrike": ["Haste", "Luck"],
            "Icicle": ["Crit", "Luck"], "Frostbeam": ["Haste", "Mastery"], "Smite": ["Mastery", "Luck"],
            "Lifebind": ["Haste", "Mastery"], "Earthfort": ["Mastery", "Versatility"], "Block": ["Mastery", "Luck"],
            "Wildpack": ["Haste", "Mastery"], "Falconry": ["Crit", "Haste"], "Dissonance": ["Haste", "Luck"],
            "Concerto": ["Haste", "Crit"]
        },
        RESTRICTIONS: {
            "Weapon": { "Strength": [], "Intelligence": [], "Agility": [] },
            "Helmet": { "Strength": ["Versatility"], "Intelligence": ["Crit"], "Agility": ["Haste"] },
            "Chest": { "Strength": ["Luck"], "Intelligence": ["Crit"], "Agility": ["Mastery"] },
            "Gloves": { "Strength": ["Haste"], "Intelligence": ["Versatility"], "Agility": ["Crit"] },
            "Boots": { "Strength": ["Mastery"], "Intelligence": ["Luck"], "Agility": ["Crit"] },
            "Earrings": { "Strength": ["Mastery"], "Intelligence": ["Versatility"], "Agility": ["Haste"] },
            "Necklace": { "Strength": ["Haste"], "Intelligence": ["Luck"], "Agility": ["Mastery"] },
            "Ring": { "Strength": ["Luck"], "Intelligence": ["Mastery"], "Agility": ["Versatility"] },
            "Bracelet (L)": { "Strength": ["Crit"], "Intelligence": ["Haste"], "Agility": ["Versatility"] },
            "Bracelet (R)": { "Strength": ["Crit"], "Intelligence": ["Mastery"], "Agility": ["Luck"] },
            "Charm": { "Strength": ["Versatility"], "Intelligence": ["Haste"], "Agility": ["Luck"] }
        },
        VALUES: {
            WEAPON_RAID: { p: 2480, s: 2480, r: 0 },
            ARMOR_RAID: { p: 954, s: 954, r: 286 },
            WEAPON_STD: { p: 1908, s: 954, r: 572 },
            ARMOR_STD: { p: 954, s: 477, r: 286 },
            GEMS: { 5: 50, 6: 60, 7: 70 }
        }
    };

    // --- 2. HELPER FUNCTIONS ---
    const $ = id => document.getElementById(id);
    const createOpt = (val, txt) => `<option value="${val}">${txt || val}</option>`;

    // --- 3. UI CONTROLLER ---
    const ui = {
        init: () => {
            // Fill Text
            $('credits-area').innerText = GAME_DATA.TEXT.CREDITS;
            $('dynamic-footer-note').innerHTML = GAME_DATA.TEXT.NOTES;

            // Fill Dropdowns
            $('class-spec').innerHTML = Object.keys(GAME_DATA.SPECS).map(s => createOpt(s)).join('');
            
            ['1', '2'].forEach(n => {
                $(`img-type-${n}`).innerHTML = createOpt("", "- None -") + GAME_DATA.IMAGINE.TYPES.map(t => createOpt(t, `Img (${t})`)).join('');
                $(`img-lvl-${n}`).innerHTML = GAME_DATA.IMAGINE.VALS.map((v, i) => createOpt(v, `Lv ${i} (+${v})`)).join('');
            });

            // Generate Grid
            const container = $('gear-container');
            container.innerHTML = GAME_DATA.SLOTS.map((slot, i) => {
                const isRaidSlot = GAME_DATA.RAID_SLOTS.includes(slot);
                const raidCheck = isRaidSlot ? `<input type="checkbox" id="raid-${i}" onchange="ui.toggleRaid(${i}, '${slot}')">` : '';
                return `
                <div class="gear-row" data-slot="${slot}">
                    <div class="slot-name">${slot}</div>
                    <div style="text-align:center">${raidCheck}</div>
                    <select id="s1-${i}" onchange="logic.updateRow(${i})"><option>-</option></select>
                    <select id="s2-${i}" onchange="logic.updateRow(${i})"><option>-</option></select>
                    <select id="s3-${i}"><option>-</option></select>
                    <div class="leg-group">
                        <select id="leg-type-${i}">${GAME_DATA.LEGENDARY.map(l => createOpt(l)).join('')}</select>
                        <input type="number" id="leg-val-${i}" class="leg-val" placeholder="%">
                    </div>
                </div>`;
            }).join('');

            // Bind Events
            document.querySelectorAll('.base-stats input').forEach(el => el.addEventListener('input', logic.calculate));
            logic.updateAll();
        },

        switchTab: (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            $(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        },

        toggleRaid: (idx, slot) => {
            const isRaid = $(`raid-${idx}`).checked;
            $(`leg-type-${idx}`).disabled = isRaid;
            $(`leg-val-${idx}`).disabled = isRaid;
            if(isRaid) { $(`leg-type-${idx}`).value = "-"; $(`leg-val-${idx}`).value = ""; }
            logic.updateRow(idx);
        }
    };

    // --- 4. CORE LOGIC ---
    const logic = {
        getBuild: () => document.querySelector('input[name="buildType"]:checked').value,
        
        updateAll: () => {
            GAME_DATA.SLOTS.forEach((_, i) => logic.updateRow(i));
            logic.calculate();
        },

        updateRow: (idx) => {
            const slot = GAME_DATA.SLOTS[idx];
            const build = logic.getBuild();
            const isRaid = $(`raid-${idx}`)?.checked || false;
            const [s1, s2, s3] = [`s1-${idx}`, `s2-${idx}`, `s3-${idx}`].map($);

            if(isRaid) {
                const specs = GAME_DATA.SPECS[$('class-spec').value];
                s1.innerHTML = createOpt(specs[0]); s1.value = specs[0]; s1.disabled = true;
                s2.innerHTML = createOpt(specs[1]); s2.value = specs[1]; s2.disabled = true;
                s3.disabled = (slot === "Weapon");
                if(slot === "Weapon") s3.value = "";
                else logic.fillSelect(s3, s3.value, null, false);
            } else {
                s1.disabled = s2.disabled = s3.disabled = false;
                const banned = GAME_DATA.RESTRICTIONS[slot]?.[build] || [];
                logic.fillSelect(s1, s1.value, s2.value, true, banned);
                logic.fillSelect(s2, s2.value, s1.value, true, banned);
                logic.fillSelect(s3, s3.value, null, false);
            }
        },

        fillSelect: (el, curr, excl, restricted, banned=[]) => {
            el.innerHTML = '<option value="">-</option>' + GAME_DATA.STATS
                .filter(s => (!restricted || !banned.includes(s)) && s !== excl)
                .map(s => createOpt(s)).join('');
            el.value = (curr && Array.from(el.options).some(o=>o.value===curr)) ? curr : "";
        },

        applyGlobal: (val) => {
            if(!val) return;
            GAME_DATA.SLOTS.forEach((_, i) => { if(!$(`s3-${i}`).disabled) $(`s3-${i}`).value = val; });
            logic.calculate();
        },

        calculate: () => {
            const total = { Versatility:0, Mastery:0, Haste:0, Crit:0, Luck:0 };
            const leg = { "Attack Speed":0, "Cast Speed":0 };
            const spec = $('class-spec').value;
            let raidBonus = null;

            GAME_DATA.SLOTS.forEach((slot, i) => {
                const [p, s, r] = [`s1-${i}`, `s2-${i}`, `s3-${i}`].map(id => $(id).value);
                const isRaid = $(`raid-${i}`)?.checked;
                let v = { p:0, s:0, r:0 };

                if(slot === "Weapon") {
                    if(isRaid) { v = GAME_DATA.VALUES.WEAPON_RAID; raidBonus = GAME_DATA.RAID_BONUS[spec]; }
                    else { v = GAME_DATA.VALUES.WEAPON_STD; }
                } else {
                    v = isRaid ? GAME_DATA.VALUES.ARMOR_RAID : GAME_DATA.VALUES.ARMOR_STD;
                }

                if(p) total[p] += v.p;
                if(s) total[s] += v.s;
                if(r) total[r] += v.r;

                if(!isRaid) {
                    const lType = $(`leg-type-${i}`).value;
                    if(leg[lType] !== undefined) leg[lType] += parseFloat($(`leg-val-${i}`).value)||0;
                }
            });

            // Imagines
            ['1','2'].forEach(n => {
                const t = $(`img-type-${n}`).value;
                if(t) total[t] += parseInt($(`img-lvl-${n}`).value)||0;
            });

            // Base Stats
            total.Versatility += parseFloat($('base-vers').value)||0;
            total.Mastery += parseFloat($('base-mast').value)||0;
            total.Haste += (parseFloat($('base-haste').value)||0) + ((parseFloat($('base-agi').value)||0)*0.2);
            total.Crit += parseFloat($('base-crit').value)||0;
            total.Luck += parseFloat($('base-luck').value)||0;

            // Apply Percent Bonuses (Raid)
            if(raidBonus && raidBonus.t === 'p') {
                if(raidBonus.l === "Luck") total.Luck *= (1 + raidBonus.v/100);
                if(raidBonus.l.includes("Shield")) total.Versatility *= (1 + raidBonus.v/100);
            }

            // Display Raw
            ['vers','mast','haste','crit','luck'].forEach((k,i) => $(`raw-${k}`).innerText = total[GAME_DATA.STATS[i]].toFixed(0));

            // Display %
            const vPct = (total.Versatility / (total.Versatility + 11200)) * 100;
            const mPct = ((total.Mastery / (total.Mastery + 20000)) * 100) + 6;
            const hPct = (total.Haste / (total.Haste + 20000)) * 100;
            const cPct = ((total.Crit / (total.Crit + 20000)) * 100) + 5;
            const lPct = ((total.Luck / (total.Luck + 16230)) * 100) + 5;

            $('r-vers').innerText = vPct.toFixed(2) + "%";
            $('r-mast').innerText = mPct.toFixed(2) + "%";
            $('r-haste').innerText = hPct.toFixed(2) + "%";
            $('r-crit').innerText = cPct.toFixed(2) + "%";
            $('r-luck').innerText = lPct.toFixed(2) + "%";

            // Extras
            $('raid-special-row').style.display = raidBonus ? 'flex' : 'none';
            if(raidBonus) {
                $('raid-special-label').innerText = `Raid ${raidBonus.l}:`;
                $('raid-special-val').innerText = `+${raidBonus.v}${raidBonus.t === 'p' ? '%' : ''}`;
            }
            $('legendary-summary').style.display = (leg["Attack Speed"]>0 || leg["Cast Speed"]>0) ? 'block' : 'none';
            $('leg-cast').innerText = `+${leg["Cast Speed"]}%`;
            $('leg-atk').innerText = `+${leg["Attack Speed"]}%`;
        }
    };

    // --- 5. OPTIMIZER ---
    const optimizer = {
        run: () => {
            const targets = {
                v: parseFloat($('opt-vers').value)||0, m: parseFloat($('opt-mast').value)||0,
                h: parseFloat($('opt-haste').value)||0, c: parseFloat($('opt-crit').value)||0, l: parseFloat($('opt-luck').value)||0
            };
            
            // CONTEXT SNAPSHOT (Performance)
            const ctx = {
                bV: parseFloat($('base-vers').value)||0, bM: parseFloat($('base-mast').value)||0,
                bH: (parseFloat($('base-haste').value)||0) + ((parseFloat($('opt-agi').value)||0)*0.2),
                bC: parseFloat($('base-crit').value)||0, bL: parseFloat($('base-luck').value)||0,
                spec: $('class-spec').value, bonus: GAME_DATA.RAID_BONUS[$('class-spec').value]
            };

            const keep = $('opt-keep-selected').checked;
            const optImg = $('opt-optimize-imagine').checked;
            const unlimRaid = $('opt-unlimited-raid').checked;
            const build = logic.getBuild();
            const specStats = GAME_DATA.SPECS[ctx.spec];

            $('opt-status').innerText = "Simulating...";
            
            // Clean UI if not keeping
            if(!keep) GAME_DATA.SLOTS.forEach((_,i) => { if($(`raid-${i}`)) $(`raid-${i}`).checked = false; });

            setTimeout(() => {
                let best = { layout: null, diff: Infinity };
                
                for(let r=0; r<15; r++) {
                    let layout = optimizer.genLayout(build, specStats, keep, optImg, unlimRaid);
                    let diff = optimizer.getDiff(optimizer.calc(layout, ctx), targets);
                    
                    for(let i=0; i<1200; i++) {
                        let mut = JSON.parse(JSON.stringify(layout));
                        optimizer.mutate(mut, build, optImg);
                        let d = optimizer.getDiff(optimizer.calc(mut, ctx), targets);
                        if(d < diff) { layout = mut; diff = d; }
                    }
                    if(diff < best.diff) best = { layout: layout, diff: diff };
                }

                optimizer.apply(best.layout);
                $('opt-status').innerText = "Done!";
                ui.switchTab('planner');
                logic.calculate();
            }, 50);
        },

        calc: (layout, ctx) => {
            let r = { v: ctx.bV, m: ctx.bM, h: ctx.bH, c: ctx.bC, l: ctx.bL };
            
            layout.img.forEach(im => { if(im.t) r[{Versatility:'v',Mastery:'m',Haste:'h'}[im.t]] += im.v; }); // Map generic to key shortcut if needed, or stick to full keys
            // Correction: Keys in `r` are single letters to match targets, but types are full strings. 
            // Better to use full strings in `r` for calculation, then map to %.
            
            let raw = { Versatility: ctx.bV, Mastery: ctx.bM, Haste: ctx.bH, Crit: ctx.bC, Luck: ctx.bL };
            
            layout.img.forEach(im => { if(im.t) raw[im.t] += im.v; });

            layout.gear.forEach((g, i) => {
                if(!g) return;
                let vals = (i===0 && g.raid) ? GAME_DATA.VALUES.WEAPON_RAID : 
                           (i===0) ? GAME_DATA.VALUES.WEAPON_STD :
                           g.raid ? GAME_DATA.VALUES.ARMOR_RAID : GAME_DATA.VALUES.ARMOR_STD;
                
                if(g.p) raw[g.p] += vals.p;
                if(g.s) raw[g.s] += vals.s;
                if(g.r) raw[g.r] += vals.r;
                if(g.g) raw[g.g] += GAME_DATA.VALUES.GEMS[g.gLvl];
            });

            if(layout.gear[0].raid && ctx.bonus && ctx.bonus.t === 'p') {
                if(ctx.bonus.l === "Luck") raw.Luck *= (1 + ctx.bonus.v/100);
                if(ctx.bonus.l.includes("Shield")) raw.Versatility *= (1 + ctx.bonus.v/100);
            }

            return {
                v: (raw.Versatility / (raw.Versatility + 11200)) * 100,
                m: ((raw.Mastery / (raw.Mastery + 20000)) * 100) + 6,
                h: (raw.Haste / (raw.Haste + 20000)) * 100,
                c: ((raw.Crit / (raw.Crit + 20000)) * 100) + 5,
                l: ((raw.Luck / (raw.Luck + 16230)) * 100) + 5
            };
        },

        getDiff: (s, t) => 
            Math.abs(s.v-t.v) + Math.abs(s.m-t.m) + Math.abs(s.h-t.h) + Math.abs(s.c-t.c) + Math.abs(s.l-t.l),

        genLayout: (build, specStats, keep, optImg, unlim) => {
            let layout = { gear: [], img: [] };
            let locked = [], raidCnt = 0;

            if(keep) {
                GAME_DATA.SLOTS.forEach((_, i) => {
                    let s1 = $(`s1-${i}`).value;
                    if(s1) {
                        let isRaid = $(`raid-${i}`)?.checked;
                        layout.gear.push({ raid: isRaid, p: s1, s: $(`s2-${i}`).value, r: $(`s3-${i}`).value, g: "Haste", gLvl: 5, locked: true });
                        locked.push(i);
                        if(isRaid) raidCnt++;
                    } else layout.gear.push(null);
                });
            } else GAME_DATA.SLOTS.forEach(() => layout.gear.push(null));

            // Raid Slots Logic
            let empty = GAME_DATA.SLOTS.map((_, i) => i).filter(i => !locked.includes(i));
            let wpRaid = (!locked.includes(0)) ? true : (layout.gear[0]?.raid);
            let armorIdx = [1,2,3,4,8,9], needed = Math.max(0, (unlim?5:4) - locked.filter(i=>armorIdx.includes(i) && layout.gear[i].raid).length);
            let raidPicks = empty.filter(i=>armorIdx.includes(i)).sort(()=>Math.random()-0.5).slice(0, needed);
            if(!locked.includes(0) && wpRaid) raidPicks.push(0);

            let seedGem = GAME_DATA.GEMS[Math.floor(Math.random()*4)];

            empty.forEach(i => {
                let isRaid = raidPicks.includes(i);
                let p, s, r = (GAME_DATA.SLOTS[i]==="Weapon" && isRaid) ? "" : GAME_DATA.STATS[Math.floor(Math.random()*5)];
                
                if(isRaid) { p = specStats[0]; s = specStats[1]; }
                else {
                    let banned = GAME_DATA.RESTRICTIONS[GAME_DATA.SLOTS[i]]?.[build] || [];
                    let av = GAME_DATA.STATS.filter(st => !banned.includes(st));
                    p = av[Math.floor(Math.random()*av.length)];
                    s = av.filter(x=>x!==p)[Math.floor(Math.random()*(av.length-1))];
                }
                layout.gear[i] = { raid: isRaid, p, s, r, g: seedGem, gLvl: 5, locked: false };
            });

            // Imagine
            if(optImg) layout.img = [0,1].map(() => ({ t: GAME_DATA.IMAGINE.TYPES[Math.floor(Math.random()*3)], v: 3584 })); // Simplified start
            else layout.img = [1,2].map(n => ({ t: $(`img-type-${n}`).value, v: parseInt($(`img-lvl-${n}`).value)||0 }));

            return layout;
        },

        mutate: (l, build, optImg) => {
            let idx = Math.floor(Math.random() * l.gear.length);
            let g = l.gear[idx];
            if(g.locked && !g.raid) return; // Skip locked

            let aspect = Math.floor(Math.random() * 5); // 0-4
            if(g.raid) aspect = Math.floor(Math.random() * 2) + 3; // Raid only gem change (3,4)

            // 0:P, 1:S, 2:R, 3:GemColor, 4:GemLvl
            if(aspect < 2) {
                let banned = GAME_DATA.RESTRICTIONS[GAME_DATA.SLOTS[idx]]?.[build] || [];
                let av = GAME_DATA.STATS.filter(st => !banned.includes(st));
                if(aspect===0) { g.p = av[Math.floor(Math.random()*av.length)]; if(g.p===g.s) g.s = av.filter(x=>x!==g.p)[0]; }
                else g.s = av.filter(x=>x!==g.p)[Math.floor(Math.random()*(av.length-1))];
            } else if (aspect === 2) {
                if(!(idx===0 && g.raid)) g.r = GAME_DATA.STATS[Math.floor(Math.random()*5)];
            } else if (aspect === 3) g.g = GAME_DATA.GEMS[Math.floor(Math.random()*4)];
            else g.gLvl = Math.floor(Math.random()*3) + 5;

            if(optImg && Math.random() < 0.1) {
                let im = l.img[Math.floor(Math.random()*2)];
                if(Math.random()<0.5) im.t = GAME_DATA.IMAGINE.TYPES[Math.floor(Math.random()*3)];
                else im.v = GAME_DATA.IMAGINE.VALS[Math.floor(Math.random()*6)];
            }
        },

        apply: (l) => {
            l.gear.forEach((g, i) => {
                if($(`raid-${i}`)) { $(`raid-${i}`).checked = g.raid; ui.toggleRaid(i, GAME_DATA.SLOTS[i]); }
                $(`s1-${i}`).value = g.p; logic.updateRow(i);
                $(`s2-${i}`).value = g.s; $(`s3-${i}`).value = g.r;
                // Implicit gem handling in logic as visual slots not present in grid yet
            });
            if(l.img.length) {
                $(`img-type-1`).value = l.img[0].t; $(`img-lvl-1`).value = l.img[0].v;
                $(`img-type-2`).value = l.img[1].t; $(`img-lvl-2`).value = l.img[1].v;
            }
        }
    };

    window.addEventListener("DOMContentLoaded", ui.init);
</script>
</body>
</html>
